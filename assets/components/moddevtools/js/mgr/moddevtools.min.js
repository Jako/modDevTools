/*!
 * modDevTools - Rapid site development helper for MODx Revolution
 * Version: 1.1.3
 * Build date: 2020-11-10
 */

var moddevtools=function(e){return e=e||{},Ext.applyIf(e,{}),moddevtools.superclass.constructor.call(this,e),this};Ext.extend(moddevtools,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{},util:{}}),Ext.reg("moddevtools",moddevtools),modDevTools=new moddevtools,modDevTools.util.renderBoolean=function(e){return e?String.format('<span class="green">{0}</span>',_("yes")):String.format('<span class="red">{0}</span>',_("no"))},modDevTools.util.getMenu=function(e,t,o){var s,n,l,r,i,a=[];for(i in e)if(e.hasOwnProperty(i)){var d=e[i];if(d.menu){if(0<a.length&&/^remove/i.test(d.action)&&a.push("-"),1<o.length){if(!d.multiple)continue;"string"==typeof d.multiple&&(d.title=d.multiple)}s=d.cls||"",n=d.icon||"",l=d.title||d.title,r=d.action?t[d.action]:"",a.push({handler:r,text:String.format('<span class="{0}"><i class="x-menu-item-icon {1}"></i>{2}</span>',s,n,l)})}else"-"===d&&a.push("-")}return a},modDevTools.util.renderActions=function(e,t,o){var s,n,l,r,i,a=[];for(r in o.data.actions)o.data.actions.hasOwnProperty(r)&&((i=o.data.actions[r]).button&&(s=i.cls||"",n=i.icon||"",l=i.action||"",i=i.title||"",i=String.format('<li class="{0}"><a class="action" href="#" data-action="{2}" title="{3}"><i class="{1}"></i></a></li>',s,n,l,i),a.push(i)));return String.format('<ul class="moddevtools-row-actions">{0}</ul>',a.join(""))},modDevTools.util.addTab=function(e,t){e=Ext.getCmp(e);e&&(Ext.applyIf(t,{id:"modx-"+Ext.id()+"-tab",layout:"form",labelAlign:"left",autoHeight:!0,defaults:{border:!1,msgTarget:"side",width:400}}),e.add(t),e.doLayout(),e.setActiveTab(0))},modDevTools.panel.SearchForm=function(e){e=e||{},Ext.applyIf(e,{cls:"container form-with-labels",labelAlign:"left",autoHeight:!0,anchor:"100%",saveMsg:_("search"),url:modDevTools.config.connectorUrl,errorReader:new Ext.data.JsonReader({totalProperty:"total",root:"results",fields:["id","name","class","type","content"]}),baseParams:{action:"mgr/search/getlist"},defaults:{border:!1},items:[{layout:"column",cls:"x-toolbar",style:{backgroundColor:"transparent"},defaults:{layout:"form",cls:"col-sm-4",border:!1},items:[{columnWidth:.4,items:[{xtype:"textfield",cls:"col-sm-4",id:"search-string",fieldLabel:_("moddevtools_text_to_find"),allowBlank:!1,anchor:"100%",border:!1,labelStyle:"line-height:24px;",listeners:{specialkey:function(e,t){13===t.getKey()&&this.submit()},scope:this}}]},{columnWidth:.4,items:[{xtype:"textfield",cls:"col-sm-4",id:"replace-string",fieldLabel:_("moddevtools_replace_with"),anchor:"100%",border:!1,labelStyle:"line-height:24px;",listeners:{specialkey:function(e,t){13===t.getKey()&&this.submit()},scope:this}}]},{columnWidth:.2,items:[{xtype:"button",cls:"col-sm-4 primary-button",align:"left",text:_("moddevtools_find"),handler:this.submit,scope:this,anchor:"100%",border:!1}]}]},{id:"filter-group",xtype:"fieldset",cls:"moddevtools-fieldset",title:_("moddevtools_search_filters"),layout:"auto",defaults:{style:{width:"auto",float:"left",marginRight:"25px"},border:!1},items:[{items:{xtype:"xcheckbox",name:"filters[modChunk]",id:"moddevtools-search-chunks",boxLabel:_("chunks"),inputValue:1,checked:!0,border:!1}},{items:{xtype:"xcheckbox",name:"filters[modTemplate]",id:"moddevtools-search-templates",boxLabel:_("templates"),inputValue:1,checked:!0,border:!1}}]},{id:"moddevtools-search-results"}],listeners:{success:{fn:function(e){var t=Ext.getCmp("moddevtools-search-results");if(t.removeAll(),e.result.success&&e.result.errors){var o=e.result.errors;this.records=o;for(var s=0;s<o.length;s++){var n={xtype:"panel",title:o[s].class+" "+o[s].name+" ("+o[s].id+")",headerCfg:{cls:"moddevtools-el-header",style:{"font-weight":"700",background:"#e4e9ee",color:"#696969"}},items:[{id:"found-element-"+s,xtype:"displayfield",value:o[s].content,height:"auto",cls:"moddevtools-search-code"}],bbar:[{xtype:"button",text:_("moddevtools_replace"),record:s,handler:function(e){this.replace(e,0,0)},scope:this},{xtype:"button",text:_("moddevtools_replace_all"),record:s,handler:function(e){this.replace(e,1,0)},scope:this},{xtype:"button",text:_("moddevtools_skip"),record:s,handler:function(e){this.replace(e,0,1)},scope:this},"->",{xtype:"button",text:_("moddevtools_edit"),record:s,item:o[s],handler:function(e){MODx.loadPage("?a=element/"+e.item.type+"/update&id="+e.item.id)},scope:this},{xtype:"button",text:_("moddevtools_quickedit"),record:s,item:o[s],handler:function(s){MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"element/"+s.item.type+"/get",id:s.item.id},listeners:{success:{fn:function(e){var t="template"===s.item.type?"templatename":"name",o=MODx.load({xtype:"modx-window-quick-update-"+s.item.type,record:e.object,listeners:{success:{fn:function(e){this.replace(s,0,1);e='<span dir="ltr">'+e.f.findField(t).getValue()+" ("+o.record.id+")</span>";o.setTitle(o.title.replace(/<span.*\/span>/,e))},scope:this},hide:{fn:function(){this.destroy()}}}});o.title+=': <span dir="ltr">'+o.record[t]+" ("+o.record.id+")</span>",o.setValues(e.object),o.show(s.target)},scope:this}}})},scope:this}]};t.add(n)}}else t.add({html:"<h3>"+_("moddevtools_notfound")+"</h3>",style:{margin:"10px 0"}});t.doLayout()},scope:this}}}),modDevTools.panel.SearchForm.superclass.constructor.call(this,e)},Ext.extend(modDevTools.panel.SearchForm,MODx.FormPanel,{replace:function(t,e,o){var s=this.records[t.record],n=this.getForm();MODx.Ajax.request({url:modDevTools.config.connectorUrl,params:{id:s.id,class:s.class,action:"mgr/search/replace",offset:e?0:s.offset,search:n.findField("search-string").getValue(),replace:n.findField(o?"search-string":"replace-string").getValue(),all:e},listeners:{success:{fn:function(e){e.success&&void 0!==e.object&&(Ext.getCmp("found-element-"+t.record).setValue(e.object.content),this.records[t.record]=e.object)},scope:this}}})}}),Ext.reg("moddevtools-search-form",modDevTools.panel.SearchForm),modDevTools.panel.RegenerateForm=function(e){e=e||{},Ext.applyIf(e,{id:"moddevtools-panel-regenerateform",cls:"container form-with-labels",labelAlign:"left",autoHeight:!0,anchor:"100%",url:modDevTools.config.connectorUrl,baseParams:{action:"mgr/tables/regenerate",register:"mgr",topic:"/regenerate/"},items:[{id:"regenerate-group",xtype:"fieldset",cls:"moddevtools-fieldset",title:_("moddevtools_regenerate_filters"),layout:"auto",defaults:{style:{width:"auto",float:"left",marginRight:"25px"},border:!1},items:[{items:{xtype:"checkbox",name:"filters[]",inputValue:"modChunk",id:"moddevtools-search-chunks",boxLabel:_("chunks"),checked:!0,border:!1}},{items:{xtype:"checkbox",name:"filters[]",inputValue:"modTemplate",id:"moddevtools-search-templates",boxLabel:_("templates"),checked:!0,border:!1}},{items:{xtype:"checkbox",name:"filters[]",inputValue:"modResource",id:"moddevtools-search-resources",boxLabel:_("resources"),checked:!0,border:!1}}]}],buttons:[{cls:"primary-button",text:_("moddevtools_regenerate"),scope:this,handler:function(){var e=Ext.getCmp("moddevtools-panel-regenerateform").getForm();null===this.console||void 0===this.console||this.console.isDestroyed?this.console=MODx.load({xtype:"modx-console",register:"mgr",topic:"/regenerate/"}):this.console.setRegister("mgr","/regenerate/"),this.console.show(Ext.getBody()),e.submit({success:{fn:function(){this.console.fireEvent("complete")},scope:this}})}}]}),modDevTools.panel.RegenerateForm.superclass.constructor.call(this,e)},Ext.extend(modDevTools.panel.RegenerateForm,MODx.FormPanel,{}),Ext.reg("moddevtools-regenerate-form",modDevTools.panel.RegenerateForm),modDevTools.panel.Home=function(e){e=e||{},Ext.apply(e,{baseCls:"modx-formpanel",layout:"anchor",hideMode:"offsets",cls:"container",items:[{html:"<h2>"+_("moddevtools")+"</h2>",cls:"modx-page-header",border:!1,style:{margin:"18px 0"}},{xtype:"modx-tabs",defaults:{border:!1,autoHeight:!0},border:!0,hideMode:"offsets",items:[{title:_("search"),layout:"anchor",items:[{html:_("moddevtools_search_desc"),border:!1,bodyCssClass:"panel-desc"},{xtype:"moddevtools-search-form"}]},modDevTools.config.accessRegenerate?{title:_("moddevtools_regenerate"),layout:"anchor",items:[{html:_("moddevtools_regenerate_desc"),border:!1,bodyCssClass:"panel-desc"},{xtype:"moddevtools-regenerate-form"}]}:{}]}]}),modDevTools.panel.Home.superclass.constructor.call(this,e)},Ext.extend(modDevTools.panel.Home,MODx.Panel),Ext.reg("moddevtools-panel-home",modDevTools.panel.Home),modDevTools.BreadcrumbsPanel=function(e){e=e||{},Ext.applyIf(e,{bdMarkup:'<tpl if="typeof(trail) != &quot;undefined&quot;"><div class="crumb_wrapper"><ul class="crumbs"><tpl for="trail"><li{[values.className != undefined ? \' class="\'+values.className+\'"\' : \'\' ]}><tpl if="typeof url != \'undefined\'"><button type="button" data-url="{url}" class="controlBtn {[values.root ? \' root\' : \'\' ]}">{text}</button></tpl><tpl if="typeof url == \'undefined\'"><span class="text{[values.root ? \' root\' : \'\' ]}">{text}</span></tpl></li></tpl></ul></div></tpl>',bodyStyle:{background:"transparent"}}),modDevTools.BreadcrumbsPanel.superclass.constructor.call(this,e)},Ext.extend(modDevTools.BreadcrumbsPanel,MODx.BreadcrumbsPanel,{onClick:function(e){e=e.getTarget();void 0===e||(e=e.getAttribute("data-url"))&&MODx.loadPage(e)},_updatePanel:function(e){this.tpl.overwrite(this.body,e);var t=this;setTimeout(function(){t.ownerCt.doLayout()},200)},getPagetitle:function(){var e,t=Ext.getCmp("modx-resource-pagetitle");return void 0!==t?0===(e=t.getValue()).length&&(e=_("new_document")):e="",e}}),Ext.reg("moddevtools-breadcrumbs-panel",modDevTools.BreadcrumbsPanel),modDevTools.panel.Elements=function(e){e=e||{},Ext.apply(e,{border:!1,baseCls:"modx-formpanel",layout:"auto",width:"100%",editors:this.editors,parentPanel:e.ownerCt.ownerCt.ownerCt,items:[{html:e.intro,border:!1,cls:"panel-desc"},{baseCls:"main-wrapper",items:[{layout:"accordion",border:!1,layoutConfig:{animate:!0},defaults:{renderHidden:!0,stateEvents:["collapse","expand"],getState:function(){return{collapsed:this.collapsed}},border:!1},items:[]}]}]}),this.getItems();var t=e.ownerCt.ownerCt;t.isDevToolsEventSet||(t.addListener("tabchange",function(){this.disableSaveButton(!0)},this),t.isDevToolsEventSet=!0),e.parentPanel.on("success",function(){this.getItems()},this),this.config=e,modDevTools.panel.Elements.superclass.constructor.call(this,e)},Ext.extend(modDevTools.panel.Elements,MODx.Panel,{getItems:function(){var l=this.config.config,e=this.config.params;new Ext.data.JsonStore({url:modDevTools.config.connectorUrl,baseParams:e,autoLoad:!0,fields:["id","name","snippet"],root:"results",totalProperty:"total",autoDestroy:!0,listeners:{load:{fn:function(e,t){this.items.itemAt(1).removeAll();for(var o=0;o<t.length;o++){var s=t[o].data,n="save"+l.element.charAt(0).toUpperCase()+l.element.substr(1),s={stateId:"state"+s.id,id:"tools-"+l.element+"-"+o,title:s.name+" ("+s.id+")",cls:"tools-item",headerCfg:{style:{padding:"10px","font-weight":"700",background:"#e4e9ee",color:"#696969"}},keys:[{key:"s",ctrl:!0,scope:this,fn:function(){this.focusedButton.fireEvent("click")}}],autoHeight:!0,items:[{cls:"main-wrapper moddevtools-element",style:{border:"1px solid #f0f0f0"},layout:"anchor",items:[{xtype:Ext.ComponentMgr.types["modx-texteditor"]&&modDevTools.config[n]?"modx-texteditor":"textarea",mimeType:l.mimeType,modxTags:l.modxTags,value:this.getElementValue(s),anchor:"100%",label:!1,height:300,id:l.element+"-editor-"+s.id,record:s,enableKeyEvents:!0,readOnly:!modDevTools.config[n],listeners:{keyup:{fn:function(){var e=Ext.getCmp("save-"+l.element+"-"+this.record.id);this.value!==this.getValue()?e.disabled&&e.setDisabled(!1):e.disabled||e.setDisabled(!0)}},focus:{fn:function(e){this.focusedEditor=e,this.focusedButton=Ext.getCmp("save-"+l.element+"-"+e.record.id),this.disableSaveButton(!0)},scope:this},afterrender:{fn:function(e){var t,o,s;"modx-texteditor"===e.xtype&&(t=e.editor,o=this.parentPanel.record.name,t.findAll(o),0<(e=this.highlightElements(t,o)).length&&t.gotoLine(e[0].end.row+1,e[0].end.column),s=this,t.getSession().on("change",function(){s.highlightElements(t,o)}))},scope:this}}},this.loadProperties(s)],bbar:modDevTools.config[n]?[{xtype:"button",id:"save-"+l.element+"-"+s.id,text:_("save"),cls:"primary-button",input:l.element+"-editor-"+s.id,disabled:!0,keys:[{key:MODx.config.keymap_save||"s",ctrl:!0}],currentPanel:this,listeners:{click:{fn:function(){if(this.disabled)return!1;var t=Ext.getCmp(this.input);this.setText(_("saving")),MODx.Ajax.request({url:MODx.config.connector_url,params:this.currentPanel.getUpdateParams(t),listeners:{success:{fn:function(e){e.success&&(t.value=t.getValue(),this.setDisabled(!0),this.setText(_("save")))},scope:this}}})}}}}]:""}],listeners:{beforecollapse:{fn:function(e,t){return!0!==t},scope:this}},collapsed:!1,collapsible:!0};this.items.itemAt(1).add(s)}this.doLayout()},scope:this}}})},getUpdateParams:function(e){return{action:"element/"+this.config.config.element+"/update",id:e.record.id,name:e.record.name,snippet:e.getValue()}},disableSaveButton:function(e){var t=Ext.getCmp("modx-action-buttons");t&&t.get(0)&&t.get(0).setDisabled(e)},highlightElements:function(e,t){var o,s=e.getSession().getMarkers(!1);for(o in s)0===s[o].clazz.indexOf("ace_selected-word")&&e.getSession().removeMarker(o);e.$search.set({needle:t});for(var n=e.$search.findAll(e.session),l=0;l<n.length;l++)e.getSession().addMarker(n[l],"ace_selected-word","text");return n}}),modDevTools.panel.Chunks=function(e){e=e||{},Ext.apply(e,{id:"tools-panel-chunks",params:{action:"mgr/chunk/getlist",parent:MODx.request.id,link_type:e.link_type},config:{element:"chunk",mimeType:"text/html",modxTags:!0}}),this.config=e,modDevTools.panel.Chunks.superclass.constructor.call(this,e)},Ext.extend(modDevTools.panel.Chunks,modDevTools.panel.Elements,{getElementValue:function(e){return e.snippet||""},loadProperties:function(){return!1}}),Ext.reg("moddevtools-panel-chunks",modDevTools.panel.Chunks),modDevTools.panel.Snippets=function(e){e=e||{},Ext.apply(e,{id:"tools-panel-snippets",params:{action:"mgr/snippet/getlist",parent:MODx.request.id,link_type:e.link_type},config:{element:"snippet",mimeType:"application/x-php",modxTags:!1}}),this.config=e,modDevTools.panel.Snippets.superclass.constructor.call(this,e)},Ext.extend(modDevTools.panel.Snippets,modDevTools.panel.Elements,{getElementValue:function(e){return"<?php\r\n"+(e.snippet||"")},loadProperties:function(e){return{xtype:"panel",listeners:{beforerender:{fn:function(n){Ext.Ajax.request({url:MODx.config.connector_url,params:{action:"element/getinsertproperties",classKey:"modSnippet",pk:e.id,propertySet:0},success:function(e){for(var t=Ext.decode(e.responseText),o="",s=0;s<t.length;s++)o+="<b>&"+t[s].fieldLabel+': </b>"'+t[s].value+'"<br/>('+t[s].description+")<br>";n.add({title:_("properties"),headerCfg:{style:{background:"#f0f0f0",margin:"10px 0 0",padding:"10px",cursor:"pointer"}},items:[{html:o,style:{padding:"15px",border:"1px solid #ececec"}}],collapsible:!0,collapsed:!0,listeners:{afterrender:function(e){e.header.on("click",function(){e.collapsed?e.expand():e.collapse()})}}}),n.doLayout()}})},scope:this}}}}}),Ext.reg("moddevtools-panel-snippets",modDevTools.panel.Snippets),modDevTools.grid.Resources=function(e){(e=e||{}).id||(e.id="moddevtools-grid-resources"),this.sm=new Ext.grid.CheckboxSelectionModel,this.config=e,Ext.applyIf(e,{url:modDevTools.config.connectorUrl,fields:this.getFields(e),columns:this.getColumns(e),tbar:!1,autoExpandColumn:"pagetitle",baseParams:{action:"mgr/resource/getlist",sort:"createdon",dir:"DESC",id:MODx.request.id,link_type:e.link_type},viewConfig:{forceFit:!0,enableRowBody:!0,autoFill:!0,showPreview:!0,scrollOffset:0,getRowClass:function(e){return e.data.published?"":"moddevtools-row-disabled"}},paging:!0,remoteSort:!0,autoHeight:!0}),this.config=e,modDevTools.grid.Resources.superclass.constructor.call(this,e)},Ext.extend(modDevTools.grid.Resources,MODx.grid.Grid,{windows:{},getMenu:function(e,t){var o=this._getSelectedIds(),t=e.getStore().getAt(t),o=modDevTools.util.getMenu(t.data.actions,this,o);this.addContextMenuItem(o)},_getSelectedIds:function(){var e,t=[],o=this.getSelectionModel().getSelections();for(e in o)o.hasOwnProperty(e)&&t.push(o[e].id);return t},_getResId:function(){var e=this._getSelectedIds();return!!e.length&&e[0]},updateResource:function(e){var t=this._getResId();if(!t)return!1;MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"resource/"+e,id:t},listeners:{success:{fn:function(){this.refresh()},scope:this}}})},unpublishResource:function(){this.updateResource("unpublish")},publishResource:function(){this.updateResource("publish")},removeResource:function(){this.updateResource("delete")},undeleteResource:function(){this.updateResource("undelete")},editResource:function(){var e=this._getResId();if(!e)return!1;MODx.loadPage("resource/update&id="+e)},previewResource:function(){window.open(this.menu.record.preview_url)},changeTemplate:function(e,t){var o=this.getSelectionModel().getSelections();if(o.length<=0)return!1;o=o[0].data;return this.changeTemplateWindow||(this.changeTemplateWindow=MODx.load({xtype:"moddevtools-window-change-template",record:o,listeners:{success:{fn:function(){this.refresh()},scope:this}}})),this.changeTemplateWindow.setValues(o),this.changeTemplateWindow.show(t.target),!0},getFields:function(){return["id","pagetitle","description","published","createdon","actions","preview_url","template"]},getColumns:function(){return[{header:_("id"),dataIndex:"id",sortable:!0,width:20},{header:_("pagetitle"),dataIndex:"pagetitle",sortable:!0,editable:!0,width:150},{header:_("published"),dataIndex:"published",renderer:modDevTools.util.renderBoolean,sortable:!0,width:40},{header:_("createdon"),dataIndex:"createdon",sortable:!0,width:50},{header:_("moddevtools_grid_actions"),dataIndex:"actions",renderer:modDevTools.util.renderActions,sortable:!1,width:60,id:"actions"},{header:_("moddevtools_template"),dataIndex:"template",sortable:!1,hidden:!0}]},onClick:function(e){var t=e.getTarget(".action",2,!0);if(t){var o=this.getSelectionModel().getSelected();if(void 0!==o){var s=t.getAttribute("data-action");if("showMenu"===s){t=this.getStore().find("id",o.id);return this._showMenu(this,t,e)}if("function"==typeof this[s])return this.menu.record=o.data,this[s](this,e)}}return this.processEvent("click",e)}}),Ext.reg("moddevtools-grid-resources",modDevTools.grid.Resources),modDevTools.window.ChangeTemplate=function(e){e=e||{},Ext.applyIf(e,{title:_("moddevtools_template_change"),url:modDevTools.config.connectorUrl,baseParams:{action:"mgr/resource/changetemplate"},width:400,fields:[{xtype:"hidden",name:"id"},{xtype:"modx-combo-template",fieldLabel:_("template"),name:"template",hiddenName:"template",anchor:"100%"}]}),modDevTools.window.ChangeTemplate.superclass.constructor.call(this,e)},Ext.extend(modDevTools.window.ChangeTemplate,MODx.Window),Ext.reg("moddevtools-window-change-template",modDevTools.window.ChangeTemplate),modDevTools.page.Home=function(e){e=e||{},Ext.applyIf(e,{components:[{xtype:"moddevtools-panel-home",renderTo:"moddevtools-panel-home-div"}]}),modDevTools.page.Home.superclass.constructor.call(this,e)},Ext.extend(modDevTools.page.Home,MODx.Component),Ext.reg("moddevtools-page-home",modDevTools.page.Home);